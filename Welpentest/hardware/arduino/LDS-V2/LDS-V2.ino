#include <SoftwareSerial.h>

SoftwareSerial mySerial(2, 3); // RX, TX

int analogPin = 5;     // potentiometer wiper (middle terminal) connected to analog pin 3
int digitalPin = 5;
int ledPin = 7;
int voltPin = 2;

int valI = 0;  
float valC = 0;  
int batI = 0;  
float batC = 0;  
int state = 0;       // variable to store the read value
boolean sendD = false;
int ledState = LOW;

void setup() {
  mySerial.begin(9600);
  Serial.begin(9600);
  pinMode(digitalPin, INPUT);        // sets the digital pin 7 as input
  pinMode(ledPin, OUTPUT);        // sets the digital pin 7 as input
}

void loop() {
  
  state = digitalRead(digitalPin);     // read the input pin
  
  if (Serial.available()) {
    
    String input = Serial.readString();
    //Serial.println(input);
    
    if (input.startsWith("start")) {
      sendD = true;
    }
    if (input.startsWith("stop")) {
      sendD = false;
    }
    if (input.startsWith("bt")) {
      state = digitalRead(digitalPin);     // read the input pin
        Serial.print("bt: ");
        Serial.println(state);      
    }
    if (input.startsWith("lds")) {
      valI = analogRead(analogPin);     // read the input pin
      valC = ((float) valI / 1023.0f) / 0.009f - 0.04f;
      Serial.print("lds: ");
      Serial.println(valC);
    }
    if (input.startsWith("bat")) {
      batI = analogRead(voltPin);     // read the input pin
      batC = ((float) batI / 1023.0f) * 9.0f;
      Serial.print("bat: ");
      Serial.println(batC);      
    }
  }
  
  if (mySerial.available()) {
    
    String input = mySerial.readString();
    //mySerial.print(input);
    
    if (input.startsWith("start")) {
      sendD = true;
    }
    if (input.startsWith("stop")) {
      sendD = false;
    }
    if (input.startsWith("bt")) {
      mySerial.print("bt: ");
      mySerial.println(state);      
    }
    if (input.startsWith("lds")) {
      valI = analogRead(analogPin);     // read the input pin
      valC = ((float) valI / 1023.0f) / 0.009f - 0.04f;
      mySerial.print("lds: ");
      mySerial.println(valC);
    }
    if (input.startsWith("bat")) {
      batI = analogRead(voltPin);     // read the input pin
      batC = ((float) batI / 1023.0f) * 9.0f;
      mySerial.print("bat: ");
      mySerial.println(batC);      
    }
  }
  
  
  
  if (sendD) {
    valI = analogRead(analogPin);     // read the input pin
    valC = ((float) valI / 1023.0f) / 0.009f - 0.04f;
    Serial.print("lds: ");
    Serial.println(valC);
    state = digitalRead(digitalPin);     // read the input pin
    if (state == HIGH) {
      mySerial.print("lds: ");
      mySerial.println(valC);
    }
  }

  if (state) {
    ledState = HIGH;
  } else {
    if (ledState == HIGH) {
      ledState = LOW;
    } else {
      ledState = HIGH;
    }
  }
  if (sendD) {
    digitalWrite(ledPin, ledState);  
    delay(25);
    digitalWrite(ledPin, LOW);  
    delay(25);
    digitalWrite(ledPin, ledState);  
  } else {
    delay(250);
  }
  digitalWrite(ledPin, ledState);  

}

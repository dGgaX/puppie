/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package de.abring.welpentest.gui.panes;

import java.awt.BasicStroke;
import java.awt.Color;
import java.awt.Font;
import java.awt.FontMetrics;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.Point;
import java.awt.Stroke;
import java.awt.font.LineMetrics;
import java.awt.geom.AffineTransform;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

/**
 *
 * @author Karima
 */
public class GraphPanel extends javax.swing.JPanel {

    public static final int DIRECT_GRAPH    = 0;
    public static final int SQUARE_GRAPH    = 1;
    public static final int BAR_GRAPH       = 2;
    
    private int maxX = 0;
    private int maxY = 0;
    
    private int graphType = GraphPanel.DIRECT_GRAPH;
    
    private final int fontHeight = 12;
    private final int margin = 5;
    private final int xGrid = (3 * margin) + fontHeight + 50;
    private final int yGrid = (3 * margin) + (2 * fontHeight);

    private final Font gridFont = new Font(Font.SERIF, Font.PLAIN, fontHeight);
    
    private Stroke gridStroke = new BasicStroke(1);
    private Stroke graphStroke = new BasicStroke(1);
    
    private Color backGroundColor = Color.WHITE;
    private Color gridColor = Color.BLACK;
    private Color graphColor = Color.RED;
    
    private String xUnitName = "Sekunden";
    private String xUnitSympol = "s";
    private String yUnitName = "Test";
    private String yUnitSympol = "t";
    
    private final List<Point> ticks = new ArrayList<>();
    
    /**
     * Creates new form GraphPanel2
     */
    public GraphPanel() {
        initComponents();
    }
    
    /**
     *
     * @param p
     */
    public void addPoint(Point p) {
        if (p == null || p.x < 0 || p.y < 0) 
            return;
        
        maxX = Math.max(maxX, p.x);
        maxY = Math.max(maxY, p.y);
        ticks.add(p);
        
        Collections.sort(ticks, (Point lhs, Point rhs) -> lhs.x < rhs.x ? -1 : (lhs.x > rhs.x) ? 1 : 0);
        this.updateUI();
    }
    
    /**
     *
     * @return
     */
    public int getDataMaxValue() {
        int i = 0;
        for (Point p : ticks) {
            i = Math.max(i, p.y);
        }
        return i;
    }
    
    /**
     *
     * @return
     */
    public float getDataAVG() {
        float i = 0.0f;
        for (Point p : ticks) {
            i += p.y;
        }
        return i / ticks.size();
    }
    
    /**
     *
     */
    public void clear() {
        maxX = 0;
        maxY = 0;
        ticks.clear();
    }
    
    /**
     *
     * @param g
     */
    @Override
    public void paintComponent(Graphics g) {
        super.paintComponent(g);
        Graphics2D g2 = (Graphics2D) g;
	g2.setBackground(backGroundColor);
        g2.clearRect(0, 0, this.getWidth(), this.getHeight());

        paintGraph(g2);


        
        if (gridStroke != null)
            g2.setStroke(gridStroke);
        g2.setColor(gridColor);
        
        g2.drawLine(xGrid, this.getHeight() - yGrid, xGrid, margin);
        
        g2.drawLine(xGrid, this.getHeight() - yGrid, this.getWidth() - margin, this.getHeight() - yGrid);
        
        g2.setFont(gridFont);
        FontMetrics fm = g2.getFontMetrics();
        
        
        
        
        AffineTransform alt = g2.getTransform();
        AffineTransform rotieren = AffineTransform.getRotateInstance(- Math.PI / 2.0d, fontHeight + margin, margin);
        g2.transform(rotieren);

        g2.drawString(yUnitName, fontHeight + margin - fm.stringWidth(yUnitName), margin);

        g2.setTransform(alt);
        
        g2.drawString(String.valueOf(0) + " " + this.yUnitSympol, xGrid - margin - fm.stringWidth(String.valueOf(0) + " " + this.yUnitSympol), this.getHeight() - yGrid);
        g2.drawString(String.valueOf(this.maxY) + " " + this.yUnitSympol, xGrid - margin - fm.stringWidth(String.valueOf(this.maxY) + " " + this.yUnitSympol), margin + fontHeight);
        
        g2.drawString(xUnitName, this.getWidth() - fm.stringWidth(xUnitName) - margin, this.getHeight() - margin);
        
        g2.drawString(String.valueOf(0) + " " + this.xUnitSympol, xGrid + margin, this.getHeight() - yGrid + margin + fontHeight);
        g2.drawString(String.valueOf(this.maxX / 1000) + " " + this.xUnitSympol, this.getWidth() - fm.stringWidth(String.valueOf(this.maxX / 1000) + " " + this.xUnitSympol) - margin, this.getHeight() - yGrid + margin + fontHeight);
        
        
        
        
        
        
    }
    
    private void paintGraph(Graphics2D g2) {
        if (ticks.isEmpty())
            return;
        if (graphStroke != null)
            g2.setStroke(graphStroke);
        g2.setColor(graphColor);
        Point l = ticks.get(0);
        try {     
            switch(graphType) {
                case GraphPanel.DIRECT_GRAPH:
                    for (Point p : ticks) {
                        g2.drawLine(Math.round(xGrid + l.x * (this.getWidth() - xGrid - margin) / (float) maxX),
                                    Math.round(this.getHeight() - yGrid - l.y * (this.getHeight() - yGrid - margin) / (float) maxY), 
                                    Math.round(xGrid + p.x * (this.getWidth() - xGrid - margin) / (float) maxX), 
                                    Math.round(this.getHeight() - yGrid - p.y * (this.getHeight() - yGrid - margin) / (float) maxY));
                        l = p;
                    }
                    break;
                case GraphPanel.SQUARE_GRAPH:
                    for (Point p : ticks) {
                        g2.drawLine(Math.round(xGrid + l.x * (this.getWidth() - xGrid - margin) / (float) maxX), 
                                    Math.round(this.getHeight() - yGrid - l.y * (this.getHeight() - yGrid - margin) / (float) maxY), 
                                    Math.round(xGrid + p.x * (this.getWidth() - xGrid - margin) / (float) maxX), 
                                    Math.round(this.getHeight() - yGrid - l.y * (this.getHeight() - yGrid - margin) / (float) maxY));
                        
                        g2.drawLine(Math.round(xGrid + p.x * (this.getWidth() - xGrid - margin) / (float) maxX), 
                                    Math.round(this.getHeight() - yGrid - l.y * (this.getHeight() - yGrid - margin) / (float) maxY), 
                                    Math.round(xGrid + p.x * (this.getWidth() - xGrid - margin) / (float) maxX), 
                                    Math.round(this.getHeight() - yGrid - p.y * (this.getHeight() - yGrid - margin) / (float) maxY));
                        l = p;
                    }
                    break;
                case GraphPanel.BAR_GRAPH:
                    for (Point p : ticks) {
                        g2.drawLine(Math.round(xGrid + p.x * (this.getWidth() - xGrid - margin) / (float) maxX), 
                                    this.getHeight() - yGrid, 
                                    Math.round(xGrid + p.x * (this.getWidth() - xGrid - margin) / (float) maxX), 
                                    Math.round(this.getHeight() - yGrid - p.y * (this.getHeight() - yGrid - margin) / (float) maxY));
                    }
                    break;
            }
        } catch (java.util.ConcurrentModificationException ex) {
            System.err.println("Graph Paint Error! EGAL!!!");
        }
    }
    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        setBackground(new java.awt.Color(255, 255, 255));
        setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(0, 0, 0)));
        setMaximumSize(new java.awt.Dimension(4000, 2000));
        setMinimumSize(new java.awt.Dimension(200, 130));
        setPreferredSize(new java.awt.Dimension(200, 130));

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 196, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 128, Short.MAX_VALUE)
        );
    }// </editor-fold>//GEN-END:initComponents


    // Variables declaration - do not modify//GEN-BEGIN:variables
    // End of variables declaration//GEN-END:variables

    /**
     * @return the stroke
     */
    public Stroke getStroke() {
        return graphStroke;
    }

    /**
     * @param stroke the stroke to set
     */
    public void setStroke(Stroke stroke) {
        this.graphStroke = stroke;
    }

    /**
     * @return the backGroundColor
     */
    public Color getBackGroundColor() {
        return backGroundColor;
    }

    /**
     * @param backGroundColor the backGroundColor to set
     */
    public void setBackGroundColor(Color backGroundColor) {
        this.backGroundColor = backGroundColor;
    }

    /**
     * @return the color
     */
    public Color getColor() {
        return graphColor;
    }

    /**
     * @param color the color to set
     */
    public void setColor(Color color) {
        this.graphColor = color;
    }

    /**
     * @return the graphType
     */
    public int getGraphType() {
        return graphType;
    }

    /**
     * @param graphType the graphType to set
     */
    public void setGraphType(int graphType) {
        this.graphType = graphType;
    }

    /**
     * @return the maxX
     */
    public int getMaxX() {
        return maxX;
    }

    /**
     * @param maxX the maxX to set
     */
    public void setMaxX(int maxX) {
        this.maxX = maxX;
    }

    /**
     * @return the maxY
     */
    public int getMaxY() {
        return maxY;
    }

    /**
     * @param maxY the maxY to set
     */
    public void setMaxY(int maxY) {
        this.maxY = maxY;
    }

    /**
     * @return the ticks
     */
    public List<Point> getData() {
        return ticks;
    }

    /**
     * @return the ticks
     */
    public List<Point> getDataCopy() {
        return new ArrayList<>(ticks);
    }

    /**
     * @return the xUnitName
     */
    public String getxUnitName() {
        return xUnitName;
    }

    /**
     * @param xUnitName the xUnitName to set
     */
    public void setxUnitName(String xUnitName) {
        this.xUnitName = xUnitName;
    }

    /**
     * @return the xUnitSympol
     */
    public String getxUnitSympol() {
        return xUnitSympol;
    }

    /**
     * @param xUnitSympol the xUnitSympol to set
     */
    public void setxUnitSympol(String xUnitSympol) {
        this.xUnitSympol = xUnitSympol;
    }

    /**
     * @return the yUnitName
     */
    public String getyUnitName() {
        return yUnitName;
    }

    /**
     * @param yUnitName the yUnitName to set
     */
    public void setyUnitName(String yUnitName) {
        this.yUnitName = yUnitName;
    }

    /**
     * @return the yUnitSympol
     */
    public String getyUnitSympol() {
        return yUnitSympol;
    }

    /**
     * @param yUnitSympol the yUnitSympol to set
     */
    public void setyUnitSympol(String yUnitSympol) {
        this.yUnitSympol = yUnitSympol;
    }

    /**
     * @return the gridColor
     */
    public Color getGridColor() {
        return gridColor;
    }

    /**
     * @param gridColor the gridColor to set
     */
    public void setGridColor(Color gridColor) {
        this.gridColor = gridColor;
    }
}
